# TCP/IP 详解 卷 1：协议

## 目录

[第 1 章 概述](#第-1-章-概述)  
[第 2 章 Internet 地址结构](#第-2-章-internet-地址结构)  
[第 3 章 链路层](#第-3-章-链路层)  
[第 4 章 地址解析协议](#第-4-章-地址解析协议)

## 第 1 章 概述

一系列相关协议的集合称为**协议族**，指定一个协议族中的各种协议之间的相互关系并划分任务的设计，称为协议族的**体系结构**或**参考模型**。TCP/IP 协议族构成了 Internet 的基础。

实现协议族的常用方案是使用一种层次结构的处理方式，这种方案被称为**分层**，通过分层，每层只负责通信的一个方面。国际标准化组织（ISO）定义了称为开放系统互连标准（OSI）的 7 层模型，但是通常认为 TCP/IP 体系结构包含 5 层。分层体系结构的一个主要优点是具有**协议复用**的能力，这种复用形式允许多种协议共存于同一基础设施中。

Internet 工程任务组（IETF）负责各种协议的制定和标准化。 Internet 中的每个标准首先作为临时的 Internet 草案存在，当草案被接收后以一个 RFC（征求意见）的形式发布，*标准跟踪*类别的 RFC 被认为是官方标准。其他类别的 RFC 包括当前最佳实践（BCP）、信息、实验和历史。

## 第 2 章 Internet 地址结构

Internet 中使用的网络层地址又称为 IP 地址。IPv4 地址的长度是 32 位，通常用**点分四组表示法**表示，由四个用点分隔的十进制数组成，如`192.168.130.118`；IPv6 地址的长度是 128 位，将称为块或字段的四个十六进制数用冒号分隔，如`5fU5:2000:80ad:5800:58:800:2023:ld71`。

IPv4 地址空间被划分为 5 大类。A，B，C 类为单播地址（用于唯一标识一个网络接口或设备的地址）分配接口，以及一些特殊状况使用；D 类供组播使用；E 类地址保留。类由地址头决定：0 为 A 类，10 为 B 类，110 为 C 类，1110 为 D 类，1111 为 E 类。在地址头后，每一个单播地址有一部分网络号，剩余位为主机号。

| 类  | 地址范围                  | 高序位 | 用途      | 百分比 | 网络数  | 主机数   |
| --- | ------------------------- | ------ | --------- | ------ | ------- | -------- |
| A   | 0.0.0.0~127.255.255.255   | 0      | 单播/特殊 | 1/2    | 128     | 16777216 |
| B   | 128.0.0.0~191.255.255.255 | 10     | 单播/特殊 | 1/4    | 16384   | 65536    |
| C   | 192.0.0.0~223.255.255.255 | 110    | 单播/特殊 | 1/8    | 2097152 | 256      |
| D   | 224.0.0.0~239.255.255.255 | 1110   | 组播      | 1/16   | N/A     | N/A      |
| E   | 240.0.0.0~255.255.255.255 | 1111   | 保留      | 1/16   | N/A     | N/A      |

为了便于分配，主机字段又被分为了子网号和主机号。例如，在一个 B 类网络中，前 16 位已被固定分配，后 16 位由网络管理员按需分配。如 8 位被分配为子网号，后 8 位为主机号，允许站点支持 256 个子网，每个子网包含 254 台主机（每个子网的第一个和最后一个地址无效）。

<img src="img/2-1.png" width=400>

为了从 IP 地址中获取网络和子网信息，需要使用**子网掩码**。子网掩码由连续的 1 后跟一些 0 组成，其中的 1 表示网络位，0 表示主机位。为了支持不同子网容纳不同数量的主机，大多数主机、路由器和路由协议支持**可变长度子网掩码**（VLSM），每个路由器和主机除了 IP 地址，还需要配置一个子网掩码。为了减少路由表的条目数，可采用分层路由思想，以**路由聚合**的方式实现。通过将相邻的多个 IP 前缀合并为一个短前缀，可以覆盖更多路由空间。

在每个 IPv4 子网中，主机号全 1 的地址被保留为*广播地址*，如`128.32.1.255/24`，使用这种地址为目的地址的数据报将发送给目标子网的所有主机，称为*定向广播*，由于安全问题，路由器默认禁止定向广播，IPv6 则没有任何广播地址，仅使用组播地址。除了定向广播地址，特殊地址`255.255.255.255`被保留为**本地网络广播**（有限广播），不会被路由器转发。

与 IPv4 不同，IPv6 地址包含范围的概念，不论是单播地址还是组播地址，都要指出地址的有效范围：节点本地/链路本地/全球范围。链路本地地址通常基于 一个标准前缀和一个 IID 创建。IPv6 组播地址的格式变化提供了基于单播前缀分配组的方法，在组中嵌入路由信息（RP 地址），并能基于 IID 创建组播地址。

IPv4 和 IPv6 的地址空间中，都包含一类**特殊用途地址**，不能用于单播地址分配。

IPv4 特殊用途地址[RFC5735]：

| 前缀               | 特殊用途                                             | 参考文献           |
| ------------------ | ---------------------------------------------------- | ------------------ |
| 0.0.0.0/8          | 当前网络（只能作为源地址使用）                       | [RFC1122]          |
| 10.0.0.0/8         | 专用网络（内联网）地址                               | [RFC1918]          |
| 127.0.0.0/8        | 回送地址，用于本地主机通信测试                       | [RFC1122]          |
| 169.254.0.0/16     | 链路本地地址，通常自动分配                           | [RFC3927]          |
| 172.16.0.0/12      | 专用网络（内联网）地址                               | [RFC1918]          |
| 192.0.0.0/24       | IETF 协议分配（IANA 保留）                           | [RFC5736]          |
| 192.0.2.0/24       | TEST-NET-1 地址                                      | [RFC5737]          |
| 192.88.99.0/24     | 用于 6to4 中继（任播地址）                           | [RFC3068]          |
| 192.168.0.0/16     | 专用网络（内联网）地址                               | [RF1918]           |
| 198.18.0.0/15      | 用于基准和性能测试                                   | [RFC2544]          |
| 198.51.100.0/24    | TEST-NET-2 地址。被批准用于文档中                    | [RFC5737]          |
| 203.0.113.0/24     | TEST-NET-3 地址。被批准用于文档中                    | [RFC5737]          |
| 224.0.0.0/4        | IPv4 组播地址（以前的 D 类），仅作为目的 IP 地址使用 | [RFC5771]          |
| 240.0.0.0/4        | 保留空间（以前的 E 类），除了 255.255.255.255        | [RFC1112]          |
| 255.255.255.255/32 | 本地网络（受限的）广播地址                           | [RFC0919][RFC0922] |

IPv6 特殊用途地址[RFC5156]：

| 前缀                | 特殊用途                                                              | 参考文献  |
| ------------------- | --------------------------------------------------------------------- | --------- |
| ::/0                | 默认路由条目。不用于寻址                                              | [RFC5156] |
| ::/128              | 未指定地址，可作为源 IP 地址使用                                      | [RFC4291] |
| ::1/128             | IPv6 主机回送地址，不用于发送出本地主机的数据报中                     | [RFC4291] |
| ::ffff:0:0/96       | IPv4 映射地址。这种地址不会出现在分组头部，仅用于内部主机             | [RFC4291] |
| ::{ipv4-address}/96 | IPv4 兼容地址。已过时，未使用                                         | [RFC4291] |
| 2001::/32           | Teredo 地址                                                           | [RFC4380] |
| 2001:10::/28        | ORCHI（覆盖可路由加密散列标识符）。这种地址不会出现在公共 Internet 中 | [RFC4843] |
| 2001:db8::/32       | 用于文档和实例的地址范围。这种地址不会出现在公共 Internet 中          | [RFC3849] |
| 2002::/16           | 6to4 隧道中继的 6to4 地址                                             | [RFC3056] |
| 3ffe::/16           | 用于 6bone 实验。已过时，未使用                                       | [RFC3701] |
| 5f00::/16           | 用于 6bone 实验。已过时，未使用                                       | [RFC3701] |
| fc00::/7            | 唯一的本地单播地址，不用于全球性的 Internet                           | [RFC4193] |
| fe80::/10           | 链路本地单播地址                                                      | [RFC4291] |
| ff00::/8            | IPv6 组播地址，仅作为目的 IP 地址使用                                 | [RFC4291] |

IP 地址空间的分配由各级权威机构完成，顶层的机构是 IANA，它负责分配 IP 地址和 Internet 协议使用的其他号码。IANA 将分配权限主要委托给几个地区性 Internet 注册机构（RIR），RIR 之间通过号码资源组织（NRO）互相协作。

## 第 3 章 链路层

TCP/IP 协议族中设计链路层的目的是为 IP 模块发送和接收 IP 数据报。它可用于携带一些支持 IP 的辅助性协议，例如 ARP（见第 4 章）。

**以太网**是一种计算机局域网技术，技术标准遵循 IEEE 802.3 标准。基本的共享以太网包含多个连接到共享的介质（电缆段）上的站，链路层的 PDU（帧）可从一个站发送到一个或更多其他站。

### 介质访问控制

由于多个站共享同一网络，需要用**介质访问控制（MAC）协议**协调哪些计算机可访问共享的介质（电缆）。以太网采用**带冲突（或称碰撞）检测的载波侦听多路访问**（CSMA/CD）算法来实现 MAC 协议。在 CSMA/CD 中，一个站（例如计算机）首先检测目前网络上正在发送的信号，并在网络空闲时发送自己的帧。这是协议中的“_载波侦听_”部分。如果其他站碰巧同时发送，发生重叠的电信号被检测为一次碰撞。在这种情况下，每个站等待一个随机时间，然后再次尝试发送。这个时间量的选择依据一个统一的概率分布，随后每个碰撞被检测到的时间长度加倍。最终，每个站会得到机会发送，或者在尝试一定次数（传统以太网为 16）后超时。CSMA/CD 是基于竞争的协议，即在任何给定的时间内，网络中只能有一个帧传输。

随着以太网的发展，基于竞争的 MAC 协议已变得不流行。局域网中每个站之间的线路通常不共享，而是通过以太网*交换机*形成专用的星形拓扑结构。交换机为以太网中的每个站提供同时发送和接收数据的能力（称为“全双工以太网”）。

### 以太网帧

<img src="img/3-1.png" width=600>

以太网帧格式以一个**前导字段**开始，接收器电路用它确定一个帧的到达时间，并确定编码位（称为时钟恢复）之间的时间量。**帧起始分隔符**（SFD）的固定值为 0xAB，在发现 SFD 时，接收器用它“恢复时钟”。

基本的帧格式包括 48 位（6 字节）的**目的地址**（DST）和**源地址**（SRC）字段。这些地址有时也采用其他名称，例如 “MAC 地址”、“链路层地址”、“802 地址”、“硬件地址”或“物理地址”。以太网帧的目的地址允许寻址到多个站点（称为“广播”或“组播”，见第 9 章）。源地址后面紧跟着一个**类型或长度**字段，它用于确定头部后面的数据类型。TCP/IP 网络中，该字段使用的常见值包括 IPv4（0x0800）、IPv6（0x86DD）和 ARP（0x0806）。在上述字段之后，［802.3 2008］提供了多种**标签**包含由其他 IEEE 标准定义的各种协议字段。之后，是帧的**数据区**或**有效载荷**部分，这里是放高层 PDU（例如 IP 数据报）的地方。传统上，以太网的有效载荷一直是 1500 字节，它代表以太网的 MTU。

有效载荷区域之后的最后字段提供了对帧完整性的检查。**循环冗余校验**（CRC）字段位于尾部，有 32 位。校验码得到的余数取反码放置在帧的**帧校验序列**（FCS）字段中。在接收到数据之后，接收方执行相同的除法计算出余数，并判断该值与 FCS 字段的值是否匹配，若不匹配，则丢弃。

以太网帧有最小和最大尺寸。最小的帧是 64 字节，要求数据区（有效载荷）长度（无标签）最小为 48 字节。当有效载荷较小时，填充字节 0 被添加到有效载荷尾部，以确保达到最小长度。传统以太网的最大帧长度是 1518 字节（包括 4 字节 CRC 和 14 字节头部），但之后扩大到 2000 字节。

如果一个站聚合的流量速率超过该站的链路速率，那么帧就开始存储在中间交换机中。如果这种情况持续一段时间，这些帧可能被丢弃。缓解这种情况的一种方法是在发送方采取**流量控制**。以太网交换机通过在交换机和网卡之间发送特殊信号帧（PAUSE 消息），通知发送方在一定时间内暂停发送。

### 网桥和交换机

网桥或交换机用于连接多个物理的链路层网络（例如一对物理的以太网段）或成组的站，交换机本质上是高性能的网桥。每个交换机（网桥）维护一张表（称为*过滤数据库*），存储每个站的 MAC 地址。当它接收到一个目的地不是自己的帧时，它将帧发送到所有端口，并更新过滤数据库。

## 第 4 章 地址解析协议

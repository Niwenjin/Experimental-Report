# 程序员的自我修养：链接、装载与库

## 目录

**第 1 部分 简介**  
第 1 章 温故而知新  
**第 2 部分 静态链接**  
[第 2 章 编译和链接](#第-2-章-编译和链接)  
[第 3 章 目标文件里有什么](#第-3-章-目标文件里有什么)  
[第 4 章 静态链接](#第-4-章-静态链接)  
[第 5 章 Windows PE/COFF](#第-5-章-windows-pecoff)  
**第 3 部分 装载与动态链接**  
第 6 章 可执行文件的装载与进程  
第 7 章 动态链接  
第 8 章 Linux 共享库的组织  
第 9 章 Windows 下的动态链接  
**第 4 部分 库与运行库**  
第 10 章 内存  
第 11 章 运行库  
第 12 章 系统调用与 API  
第 13 章 运行库实现

## 第 2 章 编译和链接

将源代码编译成可执行文件的过程可以分解为 4 个步骤：预处理（Prepressing）、编译（Compilation）、汇编（Assembly）和链接（Linking）。

**预处理**主要处理那些源代码文件中的以 “#” 开始的预编译指令，比如 “#include”、“#define” 等。预处理将源代码生成`.i`文件，相当于执行`$gcc –E hello.c –o hello.i`命令。主要处理规则如下：

-   将所有的 “#define” 删除，并且展开所有的宏定义。
-   处理所有条件预编译指令，比如 “#if”、“#ifdef”、“#elif”、“#else”、“#endif”。
-   处理 “#include” 指令，将被包含的文件插入到该预编译指令的位置。这个过程是递归进行的，也就是说被包含的文件可能还包含其他文件。
-   删除所有的注释“//”和“/\* \*/”。
-   添加行号和文件名标识，比如#2“hello.c”2，以便于编译时编译器产生调试用的行号信息及用于编译时产生编译错误或警告时能够显示行号。
-   保留所有的 #pragma 编译器指令，因为编译器须要使用它们。

**编译**过程就是把预处理完的文件进行一系列词法分析、语法分析、语义分析及优化后生产相应的汇编代码文件，这个过程往往是我们所说的整个程序构建的核心部分，也是最复杂的部分之一。编译过程将生成`.s`文件，相当于执行`$gcc –S hello.i –o hello.s`命令。编译过程一般可以分为 6 步：词法分析、语法分析、语义分析、源代码优化、代码生成和目标代码优化。

-   词法分析：扫描器（Scanner）将源代码的字符序列分割成一系列的记号（Token），包括关键字、标识符、字面量（包含数字、字符串等）和特殊符号（如加号、等号）。在识别记号的同时，扫描器也把标识符存放到符号表，将数字、字符串常量存放到文字表等。
-   语法分析：语法分析器（Grammar Parser）将对由扫描器产生的记号进行语法分析，从而产生语法树（Syntax Tree），就是以表达式（Expression）为节点的树。
-   语义分析：语义分析器（Semantic Analyzer）所能分析的语义是静态语义（Static Semantic），即在编译期可以确定的语义。静态语义通常包括声明和类型的匹配，类型的转换。经过语义分析阶段以后，整个语法树的表达式都被标识了类型。语义分析器还对符号表里的符号类型也做了更新。
-   源代码优化：源码级优化器（Source Code Optimizer）会在源代码级别进行优化。由于在语法树上作优化比较困难，所以源代码优化器往往将整个语法树转换成中间代码（Intermediate Code），它是语法树的顺序表示。比较常见的有三地址码 `x = y op z`。
-   代码生成：代码生成器（Code Generator）将中间代码转换成目标机器代码，这个过程十分依赖于目标机器，因为不同的机器有着不同的字长、寄存器、整数数据类型和浮点数数据类型等。
-   目标代码优化：目标代码优化器（Target Code Optimizer）对目标代码进行优化，比如选择合适的寻址方式、使用位移来代替乘法运算、删除多余的指令等。

**汇编**过程相对于编译器来讲比较简单，每一个汇编语句几乎都对应一条机器指令，只是根据汇编指令和机器指令的对照表一一翻译就可以了。汇编过程将生成`.o`文件，相当于执行`$gcc –c hello.c –o hello.o`命令。

**链接**过程将许多`.o`文件链接起来，生成最终的可执行程序`a.out`。链接过程主要包括了地址和空间分配（Address and Storage Allocation）、符号决议（Symbol Resolution）和重定位（Relocation）等这些步骤。

## 第 3 章 目标文件里有什么

## 第 4 章 静态链接

## 第 5 章 Windows PE/COFF
